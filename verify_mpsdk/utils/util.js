const regeneratorRuntime=require("./regenerator-runtime/runtime"),Log=require("./log"),baseUrl="https://faceid.qq.com",backupUrl="https://faceid.qcloud.com";function compareVersion(r,e){r=r.split("."),e=e.split(".");for(var o=Math.max(r.length,e.length);r.length<o;)r.push("0");for(;e.length<o;)e.push("0");for(var t=0;t<o;t++){var s=parseInt(r[t]),a=parseInt(e[t]);if(s>a)return 1;if(s<a)return-1}return 0}let requestPromise=function(r){let{url:e,method:o="POST",data:t,header:s={"Content-Type":"application/json"},reTry:a}=r;return console.log("requestPromise start:",wx.verify_TOKEN,e,t),new Promise((l,i)=>{wx.request({url:`${wx.verifyBaseUrl}`+e,method:o,data:t,header:s,success(r){console.log("requestPromise success:",r),l(r)},fail(o){console.log("requestPromise error:",o),a&&a.tryCount&&a.tryCount>0?(a.tryCount--,wx.verifyBaseUrl=backupUrl,setTimeout(()=>{l(requestPromise(r))},a.retryDelay||0)):(wx.verifyBaseUrl=baseUrl,i(o)),reportError(Log.requestFail,{url:`${wx.verifyBaseUrl}`+e,err:o})}})})},request=function(r,e){let{url:o,method:t="POST",data:s,reTry:a,header:l={"Content-Type":"application/json"}}=r;console.log("requestPromise start:",o,s);try{wx.request({url:`${wx.verifyBaseUrl}`+o,method:t,data:s,header:l,success(r){console.log("request success:",r),200===r.statusCode&&r.data?0===r.data.ErrorCode||0===r.data.code?e({ErrorCode:0,Data:r.data.Data||r.data.data}):e({ErrorCode:r.data.ErrorCode,ErrorMsg:r.data.ErrorMsg,Data:r.data.Data||r.data.data}):e({ErrorCode:-107,ErrorMsg:"request请求异常，请稍后重试"})},fail(t){console.log("request error:",t),a&&a.tryCount&&a.tryCount>0?(a.tryCount--,wx.verifyBaseUrl=backupUrl,setTimeout(()=>{request(r,e)},a.retryDelay||0)):t.errMsg.indexOf("request:fail Unable to resolve host")>=0||t.errMsg.indexOf("request:fail 似乎已断开与互联网的连接")>=0?e({ErrorCode:101,ErrorMsg:"网络异常，请稍后重试"}):e({ErrorCode:-107,ErrorMsg:"request请求异常，请稍后重试"}),reportError(Log.requestFail,{url:`${wx.verifyBaseUrl}`+o,err:t})}})}catch(r){console.log("request error:",r),e({ErrorCode:-107,ErrorMsg:"request请求异常，请稍后重试"}),reportError(Log.requestCatch,{url:`${wx.verifyBaseUrl}`+o,err:r})}},uploadFile=function(r,e){console.log(r),wx.uploadFile({url:r.url,filePath:r.filePath,name:"file",formData:r.data,success:r=>{if(console.log("uploadFile| ",r),200===r.statusCode){console.log(r);let o=JSON.parse(r.data);console.log("resTemp"),console.log(o),0===o.ErrorCode?(console.log(this.data),e({ErrorCode:0,Data:o})):e({ErrorCode:o.ErrorCode,ErrorMsg:"上传视频失败，"+o.ErrorMsg})}else e({ErrorCode:101,ErrorMsg:"上传视频失败 "+r.statusCode})},fail:r=>{console.log("upload img fail",r),e({ErrorCode:101,ErrorMsg:"上传视频失败, "+r.errMsg})}}).onProgressUpdate(r=>{this.setData({"livingbody.uploadProcess":r.progress-10<0?0:r.progress-10}),console.log("progress",r.progress),console.log("already upload data",r.totalBytesSent),console.log("all upload data",r.totalBytesExpectedToSend)})},validate=function(r,e){switch(e){case"signature":return/^\S{74}={2}$/.test(r);case"appid":return"string"==typeof r&&/^\d{4}$/.test(r);case"uid":return r;case"sms_phone":return/^1\d{10}$/.test(r);case"sms_verifyCode":return/^\d{4}$/.test(r);case"idcard":return IDNumberValid(r);case"idname":return r&&!r.match(/[A-z0-9]/g);case"idaddress":return!!r;case"end_path":return/^\//.test(r);case"token":return/^[a-zA-Z0-9-]{36}$/.test(r)}},showModal=function(r,e){wx.showModal({title:r,content:e.replace(/(^\s*)|(\s*$)/g,""),showCancel:!1,confirmText:"我知道了",confirmColor:"#2d72f1",success:function(r){r.confirm||r.cancel}})},IDNumberValid=function(r){if(!r||!/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(r))return!1;if(!{11:"北京",12:"天津",13:"河北",14:"山西",15:"内蒙古",21:"辽宁",22:"吉林",23:"黑龙江 ",31:"上海",32:"江苏",33:"浙江",34:"安徽",35:"福建",36:"江西",37:"山东",41:"河南",42:"湖北 ",43:"湖南",44:"广东",45:"广西",46:"海南",50:"重庆",51:"四川",52:"贵州",53:"云南",54:"西藏 ",61:"陕西",62:"甘肃",63:"青海",64:"宁夏",65:"新疆",71:"台湾",81:"香港",82:"澳门",91:"国外"}[r.substr(0,2)])return!1;if(18===r.length){r=r.split("");const e=[7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2],o=[1,0,"X",9,8,7,6,5,4,3,2];let t=0,s=0,a=0;for(let o=0;o<17;o++)t+=(s=r[o])*(a=e[o]);let l=o[t%11];if("x"===r[17]||"X"===r[17])return l===r[17].toUpperCase();if(l!==parseInt(r[17]))return!1}return!0},startNativeVerify=(r,e,o,t,s,a)=>{const l=r?"startFacialRecognitionVerifyAndUploadVideo":"startFacialRecognitionVerify";getUserIdKey(o,t,s,s=>{console.log("获取userIdKey成功:",s);let i=wx.startFacialRecognitionVerify;r&&(i=wx.startFacialRecognitionVerifyAndUploadVideo),i({userIdKey:s,checkAliveType:e,success(r){getWxResult(o,t,r.verifyResult,r.errCode,r.errMsg,r=>{console.log(r),a(r)}),reportMonitor(t,l,0)},fail(r){if(console.log(r),reportError(l,r),90100===r.errCode)return!1;r.errCode||0===r.errCode?getWxResult(o,t,r.verifyResult,r.errCode,r.errMsg,r=>{reportMonitor(t,l,r.ErrorCode||-1),a(r)}):wx.showModal({title:"提示",content:r.errMsg,showCancel:!1})}})})},getUserIdKey=async(r,e,o,t)=>{try{let s={url:`${r}/api/liveness/getWxUserIdKey?BizToken=${e}`};wx.showLoading({title:"加载中...",mask:!0});let a=await getUserIdKeyRequest(s);wx.hideLoading(),t(a)}catch(s){console.log(s),wx.hideLoading(),15===s.ErrorCode||14===s.ErrorCode?(15===s.ErrorCode?s.ErrorMsg="当前BizToken已过期，请重试":14===s.ErrorCode&&(s.ErrorMsg="当前BizToken已验证完成"),o({BizToken:e,ErrorCode:s.ErrorCode,ErrorMsg:s.ErrorMsg})):-1===s.ErrorCode?wx.showModal({title:"提示",content:s.ErrorMsg,showCancel:!1}):wx.showModal({title:"提示",content:s.ErrorMsg,confirmText:"重试",confirmColor:"#2d72f1",success:s=>{s.confirm&&getUserIdKey(r,e,o,t)}})}},getUserIdKeyRequest=r=>(console.log(`请求 ${r.url}`),new Promise((e,o)=>{try{wx.request({url:r.url,method:"POST",data:{},success(r){console.log("request success:",r.data),0===r.data.ErrorCode?e(r.data.Data.UserIdKey):o(r.data)},fail(r){console.log("requestPromise error:",r),r.errMsg.indexOf("request:fail Unable to resolve host")>=0||r.errMsg.indexOf("request:fail 似乎已断开与互联网的连接")>=0?o({ErrorCode:101,ErrorMsg:"网络异常，请稍后重试"}):"request:fail url not in domain list"===r.errMsg?o({ErrorCode:-1,ErrorMsg:"接口还未添加到服务器域名，请点击右上角三个点，打开调试模式再试"}):o({ErrorCode:101,ErrorMsg:r.errMsg})}})}catch(r){console.log("捕获error")}})),getWxResult=async(r,e,o,t,s,a)=>{try{wx.showLoading({title:"加载中...",mask:!0});let l=await getWxResultRequest(r,e,o,t,s);wx.hideLoading(),a(l)}catch(l){console.log(l),wx.hideLoading(),-1===l.ErrorCode?wx.showModal({title:"提示",content:l.ErrorMsg,showCancel:!1}):wx.showModal({title:"提示",content:l,confirmText:"重试",confirmColor:"#2d72f1",showCancel:!1,success:l=>{l.confirm&&getWxResult(r,e,o,t,s,a)}})}},getWxResultRequest=(r,e,o,t,s)=>(console.log(`请求 ${r}/api/liveness/getWxResult?BizToken=${e}`),new Promise((a,l)=>{wx.request({url:`${r}/api/liveness/getWxResult?BizToken=${e}`,method:"POST",data:{VerifyResult:o||"",ErrCode:t.toString(),ErrMsg:s},success(r){console.log("request success:",r.data),r.data.ErrorCode,a(r.data)},fail(r){console.log("requestPromise error:",r),r.errMsg.indexOf("request:fail Unable to resolve host")>=0||r.errMsg.indexOf("request:fail 似乎已断开与互联网的连接")>=0?l({ErrorCode:101,ErrorMsg:"网络异常，请稍后重试"}):"request:fail url not in domain list"===r.errMsg?l({ErrorCode:-1,ErrorMsg:"接口还未添加到服务器域名，请点击右上角三个点，打开调试模式再试"}):l({ErrorCode:101,ErrorMsg:r.errMsg})}})}));const getNetWorkData=()=>new Promise((r,e)=>{try{wx.getNetworkType({success(e){r(e)},fail(r){console.log("requestPromise error:",r),e({ErrorCode:101,ErrorMsg:r.errMsg})}})}catch(r){console.log("捕获error")}}),reportError=async(r,e,o)=>{if(!wx.verify_TOKEN)return;const t={tag:r,error:{version:Log.version,signalStrength:null,...e},source:"miniprogram"};try{t.system=wx.getSystemInfoSync(),t.error.signalStrength=await getNetWorkData()}catch(r){}return o&&(t.extra=o),console.log("上报错误：",t),new Promise((r,e)=>{wx.request({url:`${wx.verifyBaseUrl}/api/report/reportError`,method:"POST",data:{token:wx.verify_TOKEN,errorData:JSON.stringify(t)},success(e){r(e)},fail(r){e(r)}})})},reportMonitor=(r,e,o)=>(console.log("reportMonitor",r,e,o),new Promise((t,s)=>{wx.request({url:`${wx.verifyBaseUrl}/api/report/reportMonitor`,method:"POST",data:{token:r,pathName:e,platForm:2,errorCode:String(o),version:Log.version},success(r){t(r)},fail(r){s(r)}})})),checkIsSupportFacialRecognition=(r,e,o)=>{wx.checkIsSupportFacialRecognition({checkAliveType:e,success(){o&&o()},fail(r){wx.showModal({title:"提示",content:r.errMsg||"当前设备不支持人脸核身操作，请更换设备后重试",showCancel:!1}),r.errMsg&&-1===r.errMsg.indexOf("开发者工具")&&reportError("checkIsSupportFacialRecognition",r,{checkAliveType:e})}})};module.exports={requestPromise:requestPromise,validate:validate,compareVersion:compareVersion,showModal:showModal,request:request,uploadFile:uploadFile,startNativeVerify:startNativeVerify,reportError:reportError,reportMonitor:reportMonitor,checkIsSupportFacialRecognition:checkIsSupportFacialRecognition,getNetWorkData:getNetWorkData};